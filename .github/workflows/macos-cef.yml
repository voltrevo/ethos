name: build-macos-cef
on:
  push:
  workflow_dispatch:

env:
  # 1) Set your hardcoded start URL here.
  START_URL: "https://example.com"

  # 2) Paste a valid macOS ARM64 **Standard Distribution** CEF URL here.
  # Get one from: https://cef-builds.spotifycdn.com/index.html  (MacOS ARM64)
  # Example (replace with a current build from the site):
  CEF_DOWNLOAD: "https://cef-builds.spotifycdn.com/cef_binary_141.0.11%2Bg7e73ac4%2Bchromium-141.0.7390.123_macosarm64.tar.bz2"
  CEF_SHA1: "25191857fe1faf6862f395ffe593a84709ccf07d"

jobs:
  build-macos-arm64:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          brew install ninja cmake || true

      - name: Cache CEF download
        uses: actions/cache@v4
        with:
          path: third_party/cef
          key: cef-${{ env.CEF_SHA1 }}
          max-age-days: 3

      - name: Fetch CEF (macOS arm64)
        run: |
          if [[ -d third_party/cef ]]; then
            echo "CEF cache hit, skipping download"
          else
            mkdir -p third_party && cd third_party
            curl -L -o cef.tar.bz2 "$CEF_DOWNLOAD"
            # Verify SHA1
            echo "$CEF_SHA1  cef.tar.bz2" | shasum -c -
            tar -xjf cef.tar.bz2
            mv cef_binary_* cef
          fi

      - name: Patch cefsimple (hardcode URL)
        run: |
          bash scripts/patch_cefsimple.sh "$GITHUB_WORKSPACE"

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: third_party/cef/build
          key: cef-build-${{ env.CEF_SHA1 }}-${{ hashFiles('patches/**', 'scripts/patch_cefsimple.sh') }}
          max-age-days: 3

      - name: Configure CMake (Release, arm64)
        working-directory: third_party/cef
        run: |
          mkdir -p build && cd build
          cmake -G Ninja -DPROJECT_ARCH=arm64 -DCMAKE_BUILD_TYPE=Release ..

      - name: Build cefsimple
        working-directory: third_party/cef/build
        run: cmake --build . --target cefsimple

      - name: Sign app (ad-hoc)
        working-directory: third_party/cef/build
        run: |
          for app_path in tests/cefsimple/Release/cefsimple.app cefsimple/Release/cefsimple.app; do
            if [[ -d "$app_path" ]]; then
              echo "Signing: $app_path"
              # Sign frameworks first
              find "$app_path/Contents/Frameworks" -name "*.framework" -o -name "*.dylib" | while read framework; do
                codesign -s - -f "$framework" 2>/dev/null || true
              done
              # Sign helper executables
              find "$app_path/Contents/Frameworks" -type f -perm -111 | while read helper; do
                codesign -s - -f "$helper" 2>/dev/null || true
              done
              # Sign main app with ad-hoc signature
              codesign -s - -f --deep "$app_path"
            fi
          done

      - name: Show app path
        working-directory: third_party/cef/build
        run: |
          echo "Built app:"
          pwd
          ls -l tests/cefsimple/Release/cefsimple.app || true
          ls -l cefsimple/Release/cefsimple.app || true

      - name: Create DMG
        working-directory: third_party/cef/build
        run: |
          # Find the app bundle
          APP_PATH=""
          if [[ -d "tests/cefsimple/Release/cefsimple.app" ]]; then
            APP_PATH="tests/cefsimple/Release/cefsimple.app"
          elif [[ -d "cefsimple/Release/cefsimple.app" ]]; then
            APP_PATH="cefsimple/Release/cefsimple.app"
          fi
          
          if [[ -z "$APP_PATH" ]]; then
            echo "Error: cefsimple.app not found"
            exit 1
          fi
          
          echo "Creating DMG from: $APP_PATH"
          
          # Create DMG directly from app
          hdiutil create -volname "cefsimple" -srcfolder "$APP_PATH" -ov -format UDZO "cefsimple.dmg"
          
          # Show size
          ls -lh cefsimple.dmg

      - name: Upload app
        uses: actions/upload-artifact@v4
        with:
          name: cefsimple-macos
          path: third_party/cef/build/cefsimple.dmg
          retention-days: 3
          if-no-files-found: warn
